generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String      @id @default(uuid())
  email      String      @unique
  name       String?
  role       String      @default("USER")
  portfolios Portfolio[]
  savedFixtures      SavedFixture[]
  followedPredictions FollowedPrediction[]
  createdAt          DateTime    @default(now())
}

model SavedFixture {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  fixtureId String
  fixture   Fixture  @relation(fields: [fixtureId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, fixtureId])
}

model FollowedPrediction {
  id           String     @id @default(uuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  predictionId String
  prediction   Prediction @relation(fields: [predictionId], references: [id])
  createdAt    DateTime   @default(now())

  @@unique([userId, predictionId])
}

model League {
  id         String    @id @default(uuid())
  externalId Int       @unique
  name       String
  country    String
  fixtures   Fixture[]
}

model Team {
  id           String    @id @default(uuid())
  externalId   Int       @unique
  name         String
  homeFixtures Fixture[] @relation("HomeTeam")
  awayFixtures Fixture[] @relation("AwayTeam")
}

model Fixture {
  id          String       @id @default(uuid())
  externalId  Int          @unique
  date        DateTime
  leagueId    String
  league      League       @relation(fields: [leagueId], references: [id])
  homeTeamId  String
  homeTeam    Team         @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeamId  String
  awayTeam    Team         @relation("AwayTeam", fields: [awayTeamId], references: [id])
  homeScore   Int?
  awayScore   Int?
  status      String
  predictions Prediction[]
  savedBy     SavedFixture[]
}

model Portfolio {
  id            String   @id @default(uuid())
  name          String
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  riskValue     Float    // e.g., 0.25 (Fractional Kelly)
  bankroll      Float
  initialBankroll Float
  isActive      Boolean  @default(true)
  maxDrawdown   Float?
  circuitBreakerThreshold Float @default(0.15)

  allocations   StrategyAllocation[]
  bets          Bet[]
  createdAt     DateTime @default(now())
}

model Strategy {
  id          String   @id @default(uuid())
  name        String   @unique
  type        String   // PRE_MATCH, LIVE, ARBITRAGE, VOLATILITY
  status      String   @default("ACTIVE") // ACTIVE, INACTIVE, RETIRED
  description String?

  allocations StrategyAllocation[]
  predictions Prediction[]
  createdAt   DateTime @default(now())
}

model StrategyAllocation {
  id          String    @id @default(uuid())
  strategyId  String
  strategy    Strategy  @relation(fields: [strategyId], references: [id])
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id])

  weight      Float     // Percentage of portfolio bankroll allocated
  isActive    Boolean   @default(true)

  performance Json?     // ROI, MDD per strategy-portfolio link
  createdAt   DateTime  @default(now())
}

model MasterBankroll {
  id              String   @id @default(uuid())
  totalCapital    Float
  availableCapital Float
  updatedAt       DateTime @updatedAt
}

model Prediction {
  id             String   @id @default(uuid())
  fixtureId      String
  fixture        Fixture  @relation(fields: [fixtureId], references: [id])
  strategyId     String?
  strategy       Strategy? @relation(fields: [strategyId], references: [id])
  modelVersion   String
  homeProb       Float
  drawProb       Float
  awayProb       Float
  ev             Float
  confidence     Float
  recommendedBet String
  isCorrect      Boolean?
  
  // Auditing & Traceability
  featureSnapshot Json?   // The "Traceability" requirement
  
  followedBy     FollowedPrediction[]
  bets           Bet[]
  createdAt      DateTime @default(now())
}

model Bet {
  id             String     @id @default(uuid())
  portfolioId    String
  portfolio      Portfolio  @relation(fields: [portfolioId], references: [id])
  predictionId   String
  prediction     Prediction @relation(fields: [predictionId], references: [id])
  
  stake          Float
  odds           Float
  closingOdds    Float?
  betType        String     // e.g., "HOME", "DRAW", "AWAY"
  
  status         String     @default("PENDING") // PENDING, WON, LOST, VOID
  profit         Float?
  
  settledAt      DateTime?
  createdAt      DateTime   @default(now())
}

model MatchEvent {
  id         String   @id @default(uuid())
  fixtureId  String
  type       String   // GOAL, CARD, CORNER, SHOT, etc.
  timestamp  DateTime
  data       Json
  createdAt  DateTime @default(now())

  @@index([fixtureId, timestamp])
}

model ProviderMapping {
  id           String   @id @default(uuid())
  internalId   String
  externalId   String
  providerName String   // e.g., "sportmonks", "api-football"
  entityType   String   // e.g., "LEAGUE", "TEAM", "FIXTURE", "PLAYER"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([providerName, externalId, entityType])
  @@index([internalId, entityType])
}

model ModelArtifact {
  id           String   @id @default(uuid())
  name         String
  version      String
  path         String   // S3 path
  metadata     Json
  metrics      Json
  status       String   @default("STAGING") // STAGING, PRODUCTION, SHADOW, RETIRED
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  experiments  Experiment[]
}

model DriftMetric {
  id           String   @id @default(uuid())
  modelName    String
  metricName   String   // e.g., "feature_drift_p_value", "log_loss_calibration"
  value        Float
  timestamp    DateTime @default(now())
  tags         Json?

  @@index([modelName, timestamp])
}

model Experiment {
  id           String   @id @default(uuid())
  name         String
  description  String?
  type         String   // A_B, SHADOW, FEATURE_TEST
  status       String   @default("ACTIVE") // ACTIVE, COMPLETED, ABORTED

  modelArtifactId String
  modelArtifact   ModelArtifact @relation(fields: [modelArtifactId], references: [id])

  config       Json
  results      Json?
  startDate    DateTime @default(now())
  endDate      DateTime?
}

model RegimeState {
  id           String   @id @default(uuid())
  regime       String   // e.g., "LOW_VOLATILITY", "HIGH_VOLATILITY", "TRENDING"
  confidence   Float
  features     Json     // Features that led to this detection
  timestamp    DateTime @default(now())

  @@index([timestamp])
}

model InPlayOdds {
  id         String   @id @default(uuid())
  fixtureId  String
  bookmaker  String
  market     String
  values     Json
  timestamp  DateTime
  createdAt  DateTime @default(now())

  @@index([fixtureId, timestamp])
}
