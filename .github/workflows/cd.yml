name: CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: false # Set to true and add registry login for real use
          tags: football-api:latest

      - name: Build and push ML
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./services/ml/Dockerfile
          push: false
          tags: football-ml:latest

      - name: Build and push Web
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: false
          tags: football-web:latest

      # Example deployment step to Kubernetes
      # - name: Deploy to K8s
      #   uses: azure/k8s-deploy@v4
      #   with:
      #     namespace: 'production'
      #     manifests: |
      #       k8s/helm/football-intelligence/templates/*.yaml
      #     images: |
      #       football-api:latest
      #       football-ml:latest
      #       football-web:latest
